<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Architecting mobile apps with Kotlin Multiplatform - Rafa Garcia</title>
<meta name="description" content="Learn how to architect mobile apps with Kotlin Multiplatform. Discover the benefits, understand the architecture, and explore a practical example">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_UK">
<meta property="og:site_name" content="Rafa Garcia">
<meta property="og:title" content="Architecting mobile apps with Kotlin Multiplatform">
<meta property="og:url" content="/architecting-mobile-apps-with-kotlin-multiplatform/">


  <meta property="og:description" content="Learn how to architect mobile apps with Kotlin Multiplatform. Discover the benefits, understand the architecture, and explore a practical example">



  <meta property="og:image" content="/assets/images/alhambra-stonks.jpg">





  <meta property="article:published_time" content="2023-06-16T00:00:00+00:00">






<link rel="canonical" href="/architecting-mobile-apps-with-kotlin-multiplatform/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Rafa Garcia",
      "url": "/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Rafa Garcia Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    <style>
</style>
    <style>
</style>
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Rafa Garcia
          <span class="site-subtitle">Android Developer | Software Engineer</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blog/">Blog</a>
            </li><li class="masthead__menu-item">
              <a href="/cv/">CV</a>
            </li><li class="masthead__menu-item">
              <a href="/portfolio/">Portfolio</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content"
  padding-left: 80px>
      
  







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="/assets/images/alhambra-stonks.jpg" alt="Architecting mobile apps with Kotlin Multiplatform" class="page__hero-image">
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/rafa_avatar.jpeg" alt="" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Engineering in broken English</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">London / Granada</span>
        </li>
      

      
        
          
            <li><a href="mailto:rafagarfer@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/rafa_piki" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/rafagf/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/rafaelgarciafernandez/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">Linkedin</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Architecting mobile apps with Kotlin Multiplatform">
    <meta itemprop="description" content="Note: This article has been featured in both Android Weekly (#490) and Kotlin Weeekly (#273). Thanks to both! üôè">
    <meta itemprop="datePublished" content="2023-06-16T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Architecting mobile apps with Kotlin Multiplatform
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><em>Note: This article has been featured in both <a href="https://androidweekly.net/issues/issue-490">Android Weekly (#490)</a> and <a href="https://mailchi.mp/kotlinweekly/kotlin-weekly-273">Kotlin Weeekly (#273)</a>. Thanks to both!</em> üôè</p>

<p>KMM is a hot topic in mobile development. Before we dive into how architecting mobile apps with Kotlin Multiplatform can be done, let‚Äôs summarise its main advantages:</p>

<ul>
  <li><strong>Sharing code across platforms</strong>: meaning less code to maintain, fewer bugs (or at least consistent bugs across platforms! üòÑ) and, in general fewer efforts to ship new features.</li>
  <li><strong>UI remains managed by platform specialists</strong>: Android or iOS devs can do their magic interacting directly with their preferred UI toolkits, just the way they‚Äôre used to.</li>
</ul>

<p>As KMM‚Äôs popularity grows and more teams adopt it, questions about how to architecture mobile apps around it arise. While adoption might sound like a big shift on how we normally build mobile apps, it actually turns out that the change can be relatively straightforward if we already have a decent architecture in place (ü§û).</p>

<h3 id="quick-refresher-on-mobile-architecture">Quick refresher on mobile architecture</h3>

<p>Mobile architecture/design is a vast topic that would be impossible to cover here, however, I‚Äôd like to layout at a very high level the main layers a mobile app would normally have before we start seeing code:</p>

<ul>
  <li><strong>UI</strong>: views that are displayed in the screen, rendered using <em>UIKit</em> or <em>SwiftUI</em> in iOS and the <em>Android UI toolkit</em> or <em>Jetpack Compose</em> in Android.</li>
  <li><strong>Presentation</strong>: logic about what is about to be <em>presented</em> in the screen (i.e <em>ViewModels</em> or <em>Presenters</em>).</li>
  <li><strong>Domain</strong>: the logic/rules of our business, normally driven by the usage of <em>UseCases</em>.</li>
  <li><strong>Data</strong>: repositories to orchestrate fetching data from different data sources, like a database or a remote API.</li>
</ul>

<p>Modern patterns focus on having a reactive uni-directional data flow through these layers: <strong>UI</strong> -&gt; <strong>Presentation</strong> -&gt; <strong>Domain</strong> -&gt; <strong>Data</strong> -&gt; <strong>Domain</strong> -&gt; <strong>Presentation</strong> -&gt; <strong>UI</strong>, where a layer only knows its lower neighbour (i.e <em>Data</em> is only known by <em>Domain</em> and not the other way around).</p>

<h3 id="lets-get-to-business-architecting-mobile-apps-for-kotlin-multiplatform">Let‚Äôs get to business. Architecting mobile apps for Kotlin Multiplatform</h3>

<p>To showcase how an app using KMM could look like I‚Äôve built <a href="https://github.com/Rafagf/stonks"><em>Stonks</em></a>, a small open-source KMM library with a companion Android app consuming it. <em>Stonks</em> is a small app to track stocks: it has a search screen where the user can add favourite stocks and the main screen where you can see the stock‚Äôs current price (aka <em>Quote</em>) and its change in the last 24 hours.</p>

<p align="center">
<img src="/assets/images/stonks-faved-light.png" height="500" width="250" /> | <img src="/assets/images/stonks-search-light.png" height="500" width="250" />
</p>

<h3 id="what-layers-could-we-reuse">What layers could we reuse?</h3>

<p>Looking at our architecture layers, we need to start from the lowest and ask ourselves:</p>

<blockquote>
  <p>Is this something that iOS and Android can reuse?</p>
</blockquote>

<p>The first layer we should consider is <strong>Data</strong> (aka repositories). To know if it can be part of a shared KMM library, we need to understand its responsibilities:</p>

<ul>
  <li><strong>Fetch data from a remote data source</strong>: we need to fetch our stocks from somewhere, right? Luckily for us, <a href="https://kotlinlang.org/docs/kmm-use-ktor-for-networking.html">Ktor client</a> is available on KMM, which allows us to do API calls to any given server. ¬†‚úÖ</li>
  <li><strong>Fetch data from a persistence data source</strong>: being online is great, but sometimes our phone won‚Äôt have internet connection and we want our app to still work. KMM to the rescue again thanks to the awesome library <a href="https://cashapp.github.io/sqldelight/multiplatform_sqlite/">SQLDelight</a>, which allows us to persist our data in a database (along with goodies such as typesafe APIs from SQL statements, migrations checks at compile time, etc). ‚úÖ</li>
</ul>

<p>Sounds like we are good to put the data layer in our shared KMM library, let‚Äôs get to it üéâ.</p>

<h3 id="implementing-our-data-sources">Implementing our data sources</h3>

<p>Before we get to work on our first repository, let‚Äôs make sure we get both remote and local data sources working.</p>

<p>The remote data source is quite straightforward, we can create a http client by doing this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">BASE_URL</span> <span class="p">=</span> <span class="s">"https://myurl/api/v1"</span>

<span class="k">internal</span> <span class="kd">class</span> <span class="nc">StonksHttpClient</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">client</span><span class="p">:</span> <span class="nc">HttpClient</span> <span class="p">=</span> <span class="nf">defaultHttpClient</span><span class="p">(),</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">baseUrl</span><span class="p">:</span> <span class="nc">String</span> <span class="p">=</span> <span class="nc">BASE_URL</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="k">internal</span> <span class="k">suspend</span> <span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="k">reified</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="nf">execute</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">T</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">client</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="s">"$baseUrl${request.url}"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">method</span> <span class="p">=</span> <span class="nc">HttpMethod</span><span class="p">.</span><span class="nc">Get</span>
            <span class="k">this</span><span class="p">.</span><span class="n">body</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">body</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">defaultHttpClient</span><span class="p">()</span> <span class="p">=</span> <span class="nc">HttpClient</span> <span class="p">{</span>
    <span class="nf">install</span><span class="p">(</span><span class="nc">JsonFeature</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serializer</span> <span class="p">=</span> <span class="nc">KotlinxSerializer</span><span class="p">(</span><span class="nc">Json</span> <span class="p">{</span>
            <span class="n">prettyPrint</span> <span class="p">=</span> <span class="k">true</span>
            <span class="n">isLenient</span> <span class="p">=</span> <span class="k">true</span>
            <span class="n">ignoreUnknownKeys</span> <span class="p">=</span> <span class="k">true</span>
        <span class="p">})</span>
    <span class="p">}</span>
    <span class="nf">install</span><span class="p">(</span><span class="nc">Logging</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">level</span> <span class="p">=</span> <span class="nc">LogLevel</span><span class="p">.</span><span class="nc">HEADERS</span>
        <span class="n">logger</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">Logger</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Api: message = $message"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="kd">data class</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;(</span>
    <span class="kd">val</span> <span class="py">url</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">method</span><span class="p">:</span> <span class="nc">Method</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">body</span><span class="p">:</span> <span class="nc">OutgoingContent</span> <span class="p">=</span> <span class="nc">EmptyContent</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">Method</span> <span class="p">{</span> <span class="nc">GET</span><span class="p">,</span> <span class="nc">POST</span><span class="p">,</span> <span class="nc">DELETE</span> <span class="p">}</span>
</code></pre></div></div>

<p>For the persistence data source, it gets a bit more complicated. We need to provide <a href="https://kotlinlang.org/docs/kmm-configure-sqldelight-for-data-storage.html#create-an-sqlite-driver">multiple platform-specific implementations of the SQLite Driver</a>. We can do this by using the <code class="language-plaintext highlighter-rouge">expect / actual</code> mechanism of KMM.</p>

<p>In the folder <code class="language-plaintext highlighter-rouge">commonMain</code> (where common code for all platforms live), we can have the following interface:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">expect</span> <span class="kd">class</span> <span class="nc">DatabaseDriverFactory</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">createDriver</span><span class="p">():</span> <span class="nc">SqlDriver</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We now provide both android (<code class="language-plaintext highlighter-rouge">androidMain</code>) and iOS (<code class="language-plaintext highlighter-rouge">iosMain</code>) implementations:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">actual</span> <span class="kd">class</span> <span class="nc">DatabaseDriverFactory</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">createDriver</span><span class="p">():</span> <span class="nc">SqlDriver</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">AndroidSqliteDriver</span><span class="p">(</span><span class="nc">StonksDatabase</span><span class="p">.</span><span class="nc">Schema</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="s">"android.db"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">actual</span> <span class="kd">class</span> <span class="nc">DatabaseDriverFactory</span> <span class="p">{</span>
    <span class="n">actual</span> <span class="k">fun</span> <span class="nf">createDriver</span><span class="p">():</span> <span class="nc">SqlDriver</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">NativeSqliteDriver</span><span class="p">(</span><span class="nc">StonksDatabase</span><span class="p">.</span><span class="nc">Schema</span><span class="p">,</span> <span class="s">"ios.db"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And voila, we‚Äôre now ready to create our database tables, which we‚Äôll do shortly.</p>

<h3 id="building-our-first-repository">Building our first repository</h3>

<p>Let‚Äôs focus on building the <code class="language-plaintext highlighter-rouge">QuoteRepository</code>, which will be used to fetch a stock quote given a symbol (i.e <code class="language-plaintext highlighter-rouge">GOOGL</code> for Google). From now on we‚Äôll be only using <code class="language-plaintext highlighter-rouge">commonMain</code> folder since everything is going to be common for both platforms.</p>

<p>The first step is creating our repository‚Äôs interface, which will technically live in a package called <code class="language-plaintext highlighter-rouge">domain</code> since repositories interfaces are considered to be part of this layer.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">QuoteRepository</span> <span class="p">{</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Quote</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">Quote</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">current</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">high</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">low</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">open</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">previousClose</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>We‚Äôve got our <code class="language-plaintext highlighter-rouge">StonksHttpClient</code> ready to make API calls, however, we haven‚Äôt created how a request looks like yet. Let‚Äôs do it.</p>

<p><em>Note: For Stonks, we‚Äôre using an open source stock provider called <a href="https://finnhub.io/">Finnhub</a> to fetch stock quotes.</em></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="kd">object</span> <span class="nc">QuoteApi</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">quoteRequest</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">=</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="nc">ApiQuoteResponse</span><span class="p">&gt;(</span>
        <span class="n">method</span> <span class="p">=</span> <span class="nc">GET</span><span class="p">,</span>
        <span class="n">url</span> <span class="p">=</span> <span class="s">"quote?symbol=${symbol}"</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Serializable</span>
<span class="k">internal</span> <span class="kd">data class</span> <span class="nc">ApiQuoteResponse</span><span class="p">(</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"c"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">current</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"h"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">high</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"l"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">low</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"o"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">open</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="nd">@SerialName</span><span class="p">(</span><span class="s">"pc"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">previousClose</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>And similarly, for the persistence data source, we‚Äôve got our DB setup but we haven‚Äôt created any tables. We can create our <code class="language-plaintext highlighter-rouge">DbQuote</code> table by creating a <code class="language-plaintext highlighter-rouge">DbQuote.sq</code> file.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">DbQuote</span> <span class="p">(</span>
  <span class="n">symbol</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="k">current</span> <span class="nb">REAL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">high</span> <span class="nb">REAL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">low</span> <span class="nb">REAL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">open</span> <span class="nb">REAL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">previousClose</span> <span class="nb">REAL</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">get</span><span class="p">:</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">DbQuote</span>
<span class="k">WHERE</span> <span class="n">symbol</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>

<span class="n">upsert</span><span class="p">:</span>
<span class="k">INSERT</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">INTO</span> <span class="n">DbQuote</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">);</span>

</code></pre></div></div>

<p>In here, we‚Äôve specified how the table should look like and how we want to interact with it (<code class="language-plaintext highlighter-rouge">get</code> to fetch a quote, <code class="language-plaintext highlighter-rouge">upsert</code> to update/insert new ones). This file will generate the table and Kotlin APIs to interact with it. For better readability, we can wrap its usage under a <code class="language-plaintext highlighter-rouge">QuotePersistence</code> class like this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">QuotePersistence</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">db</span><span class="p">:</span> <span class="nc">StonksDatabase</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">apiResponse</span><span class="p">:</span> <span class="nc">ApiQuoteResponse</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">db</span><span class="p">.</span><span class="n">dbQuoteQueries</span><span class="p">.</span><span class="nf">upsert</span><span class="p">(</span>
            <span class="n">symbol</span> <span class="p">=</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="n">current</span> <span class="p">=</span> <span class="n">apiResponse</span><span class="p">.</span><span class="n">current</span><span class="p">,</span>
            <span class="n">high</span> <span class="p">=</span> <span class="n">apiResponse</span><span class="p">.</span><span class="n">high</span><span class="p">,</span>
            <span class="n">low</span> <span class="p">=</span> <span class="n">apiResponse</span><span class="p">.</span><span class="n">low</span><span class="p">,</span>
            <span class="n">open_</span> <span class="p">=</span> <span class="n">apiResponse</span><span class="p">.</span><span class="k">open</span><span class="p">,</span>
            <span class="n">previousClose</span> <span class="p">=</span> <span class="n">apiResponse</span><span class="p">.</span><span class="n">previousClose</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">DbQuote</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">db</span><span class="p">.</span><span class="n">dbQuoteQueries</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">).</span><span class="nf">executeAsOne</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Aaaand we‚Äôre now in a great position to create the implementation of our <code class="language-plaintext highlighter-rouge">QuoteRepository</code> üíØ</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">QuoteRepositoryImpl</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="nc">StonksHttpClient</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">persistence</span><span class="p">:</span> <span class="nc">QuotePersistence</span><span class="p">,</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">QuoteRepository</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Quote</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
            <span class="nf">fromApi</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">fromDb</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">fromApi</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Quote</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">apiResponse</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="nc">QuoteApi</span><span class="p">.</span><span class="nf">quoteRequest</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
        <span class="n">persistence</span><span class="p">.</span><span class="nf">upsert</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">apiResponse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">apiResponse</span><span class="p">.</span><span class="nf">toModel</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">fromDb</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Quote</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
            <span class="n">persistence</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">).</span><span class="nf">toModel</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">ErrorFetchingQuote</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">ErrorFetchingQuote</span><span class="p">(</span><span class="kd">val</span> <span class="py">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="k">override</span> <span class="kd">val</span> <span class="py">cause</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Throwable</span><span class="p">(</span><span class="s">"Could not fetch favourites -  $cause"</span><span class="p">)</span>

<span class="k">internal</span> <span class="k">fun</span> <span class="nc">ApiQuoteResponse</span><span class="p">.</span><span class="nf">toModel</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">=</span> <span class="nc">Quote</span><span class="p">(</span>
    <span class="n">symbol</span> <span class="p">=</span> <span class="n">symbol</span><span class="p">,</span>
    <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">,</span>
    <span class="n">high</span> <span class="p">=</span> <span class="n">high</span><span class="p">,</span>
    <span class="n">low</span> <span class="p">=</span> <span class="n">low</span><span class="p">,</span>
    <span class="k">open</span> <span class="p">=</span> <span class="k">open</span><span class="p">,</span>
    <span class="n">previousClose</span> <span class="p">=</span> <span class="n">previousClose</span>
<span class="p">)</span>

<span class="k">internal</span> <span class="k">fun</span> <span class="nc">DbQuote</span><span class="p">.</span><span class="nf">toModel</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Quote</span><span class="p">(</span>
    <span class="n">symbol</span> <span class="p">=</span> <span class="n">symbol</span><span class="p">,</span>
    <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">,</span>
    <span class="n">high</span> <span class="p">=</span> <span class="n">high</span><span class="p">,</span>
    <span class="n">low</span> <span class="p">=</span> <span class="n">low</span><span class="p">,</span>
    <span class="k">open</span> <span class="p">=</span> <span class="n">open_</span><span class="p">,</span>
    <span class="n">previousClose</span> <span class="p">=</span> <span class="n">previousClose</span>
<span class="p">)</span>
</code></pre></div></div>

<p>As you can see, the repository specifies a policy in which it will always check first the remote data source and then fall back to persistence in case of error. Boom, we‚Äôre done üí•</p>

<h3 id="propagating-db-changes-with-kotlin-flow">Propagating DB changes with Kotlin Flow</h3>

<p>One of my coding dreams as an Android Developer has always been having an architecture where table updates are immediately propagated to ‚Äòconnected‚Äô views by reactive patterns. I was surprised at how easy this is using <a href="https://kotlinlang.org/docs/flow.html">Kotlin Flow</a>.</p>

<p>For example, we want <em>Stonks</em> users to be able to select favourites stocks. For simplicity, this information will only live in the device (persistence data source). The final implementation of this <code class="language-plaintext highlighter-rouge">FavouritesRepository</code> would look like this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">FavouritesRepository</span> <span class="p">{</span>

    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getAll</span><span class="p">():</span> <span class="nc">Flow</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;&gt;</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">save</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>
    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">unsave</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="kd">class</span> <span class="nc">FavouritesRepositoryImpl</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">persistence</span><span class="p">:</span> <span class="nc">FavouritesPersistence</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">FavouritesRepository</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getAll</span><span class="p">():</span> <span class="nc">Flow</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
            <span class="n">persistence</span><span class="p">.</span><span class="nf">getAll</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">ErrorFetchingFavourites</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">save</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">persistence</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">ErrorSavingFavourite</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">unsave</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">persistence</span><span class="p">.</span><span class="nf">unsave</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">ErrorUnSavingFavourite</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">data class</span> <span class="nc">ErrorFetchingFavourites</span><span class="p">(</span><span class="k">override</span> <span class="kd">val</span> <span class="py">cause</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Throwable</span><span class="p">(</span><span class="s">"Could not fetch favourites -  $cause"</span><span class="p">)</span>
    <span class="kd">data class</span> <span class="nc">ErrorSavingFavourite</span><span class="p">(</span><span class="kd">val</span> <span class="py">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="k">override</span> <span class="kd">val</span> <span class="py">cause</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Throwable</span><span class="p">(</span><span class="s">"Symbol $symbol couldn't be saved - $cause"</span><span class="p">)</span>
    <span class="kd">data class</span> <span class="nc">ErrorUnSavingFavourite</span><span class="p">(</span><span class="kd">val</span> <span class="py">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="k">override</span> <span class="kd">val</span> <span class="py">cause</span><span class="p">:</span> <span class="nc">Throwable</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Throwable</span><span class="p">(</span><span class="s">"Symbol $symbol couldn't be unsaved -  $cause"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And our <code class="language-plaintext highlighter-rouge">FavouritesPersistence</code>, similar to what we saw for <code class="language-plaintext highlighter-rouge">Quotes</code>, will be like this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">internal</span> <span class="kd">class</span> <span class="nc">FavouritesPersistence</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">db</span><span class="p">:</span> <span class="nc">StonksDatabase</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">getAll</span><span class="p">()</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">dbFavouritesQueries</span><span class="p">.</span><span class="nf">getAll</span><span class="p">().</span><span class="nf">asFlow</span><span class="p">().</span><span class="nf">mapToList</span><span class="p">()</span>

    <span class="k">fun</span> <span class="nf">save</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">dbFavouritesQueries</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">fun</span> <span class="nf">unsave</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">dbFavouritesQueries</span><span class="p">.</span><span class="nf">unsave</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Keen eyes might have noticed that our <code class="language-plaintext highlighter-rouge">getAll()</code> method returns a <code class="language-plaintext highlighter-rouge">Flow&lt;List&lt;String&gt;&gt;</code>. This is because our persistence <code class="language-plaintext highlighter-rouge">getAll</code> returns  favourites as <code class="language-plaintext highlighter-rouge">.asFlow().mapToList()</code>, which basically will trigger the method and introduce its returned content into the Flow‚Äôs pipeline as soon as there is any update in the table. This means that <strong>any client using the Flow could render live updates as they happen</strong>.</p>

<p>For example, in Android we could have something like this to unwrap the DB updates:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Code sitting in an Android ViewModel for example, similar for iOS</span>
<span class="k">fun</span> <span class="nf">load</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">viewModelScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="n">fetchFavedQuotesUseCase</span><span class="p">.</span><span class="nf">invoke</span><span class="p">()</span> <span class="c1">//---&gt; the method which returns our Flow</span>
                <span class="p">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="nc">FavedState</span><span class="p">.</span><span class="nc">Error</span> <span class="p">}</span>
                <span class="p">.</span><span class="nf">collect</span> <span class="p">{</span> <span class="n">favedQuotes</span> <span class="p">-&gt;</span>
                    <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="nc">FavedState</span><span class="p">.</span><span class="nc">Content</span><span class="p">(</span>
                        <span class="n">quotes</span> <span class="p">=</span> <span class="n">favedQuotes</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span>
                            <span class="n">it</span><span class="p">.</span><span class="nf">toFavedQuoteUi</span><span class="p">()</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To see this in action in <em>Stonks</em>, we can go to the search page, mark a stonk as favourite and come back to the main page. The stock will be there waiting for us magically without us having to refresh the page¬†üëá.</p>
<p align="center" width="100%">
  <img src="/assets/images/stonks-flow.gif" height="500" width="250" />
</p>
<h3 id="could-we-go-even-further">Could we go even further?</h3>

<p align="center" width="100%">
  <img src="https://media.giphy.com/media/kPtv3UIPrv36cjxqLs/giphy.gif" />
</p>

<p>Next layer on our diagram would be <code class="language-plaintext highlighter-rouge">Domain</code>. Can we move it to a KMM library?</p>

<p>The answer is <strong>YES! And we should definitely do it!</strong> Before we get to the code, I want to highlight what are the advantages of moving this into our KMM library. Also, for simplicity, I think we can simplify the term <em>domain logic</em> to ‚Äòuse cases‚Äô.</p>

<ul>
  <li>By sharing use cases <strong>we get consistency on how they‚Äôre consumed in the presentation layer across Android &amp; iOS</strong>, which helps to more consistent features across teams.</li>
  <li>We <strong>no longer need to expose repositories to clients</strong> (i.e they can have <em>internal</em> visibility in our shared library), which avoid bad usage of them - hands up who hasn‚Äôt worked in an app where repositories were injected all over the place‚Ä¶</li>
  <li>It could already be the case without using a KMM library, but in general, we contribute to a <a href="https://proandroiddev.com/why-you-need-use-cases-interactors-142e8a6fe576">Use Case Driven architecture</a>, where each app action has a use case <em>and</em> potentially each repository method has a Use Case associated to it.</li>
  <li>And of course, <strong>we reduce at least by half the number of code to write</strong>, and therefore the bugs üêõ.</li>
</ul>

<p>Back to <em>Stonks</em>, our main screen will display a list of quotes for all the stocks that have been faved by the user, meaning we need to make use of two repositories to fetch the data we need: <code class="language-plaintext highlighter-rouge">QuoteRepository</code> and <code class="language-plaintext highlighter-rouge">FavouritesRepository</code>.</p>

<p>Our cross-platform use case would look like this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">FetchFavedQuotesUseCase</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">quoteRepository</span><span class="p">:</span> <span class="nc">QuoteRepository</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">favouritesRepository</span><span class="p">:</span> <span class="nc">FavouritesRepository</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">():</span> <span class="nc">Flow</span><span class="p">&lt;</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">FavedQuote</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">favouritesRepository</span><span class="p">.</span><span class="nf">getAll</span><span class="p">().</span><span class="nf">flatMapConcat</span> <span class="p">{</span> <span class="n">favedSymbols</span> <span class="p">-&gt;</span>
            <span class="nf">flowOf</span><span class="p">(</span><span class="nf">quotes</span><span class="p">(</span><span class="n">favedSymbols</span><span class="p">).</span><span class="nf">toFavedQuote</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">quotes</span><span class="p">(</span><span class="n">symbols</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Quote</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">symbols</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span>
            <span class="n">quoteRepository</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">List</span><span class="p">&lt;</span><span class="nc">Quote</span><span class="p">&gt;.</span><span class="nf">toFavedQuote</span><span class="p">()</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">toFavedQuote</span><span class="p">()</span> <span class="p">}</span>

<span class="k">fun</span> <span class="nc">Quote</span><span class="p">.</span><span class="nf">toFavedQuote</span><span class="p">()</span> <span class="p">=</span> <span class="nc">FavedQuote</span><span class="p">(</span>
    <span class="n">symbol</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span>
    <span class="n">current</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">current</span><span class="p">,</span>
    <span class="k">open</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="k">open</span><span class="p">,</span>
<span class="p">)</span>

<span class="kd">data class</span> <span class="nc">FavedQuote</span><span class="p">(</span>
    <span class="kd">val</span> <span class="py">symbol</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">current</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">open</span><span class="p">:</span> <span class="nc">Double</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>And to finish giving the whole example, it would be consumed in Android and iOS presentation layers to then render the data using our preferred UI toolkits (Compose ‚ù§Ô∏è SwiftUI). A very simple Android example could look similar to this:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">FavedViewModel</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">fetchFavedQuotesUseCase</span><span class="p">:</span> <span class="nc">FetchFavedQuotesUseCase</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">toggleFavouriteUseCase</span><span class="p">:</span> <span class="nc">ToggleFavouriteUseCase</span><span class="p">,</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">_state</span> <span class="p">=</span> <span class="nc">MutableStateFlow</span><span class="p">&lt;</span><span class="nc">FavedState</span><span class="p">&gt;(</span><span class="nc">FavedState</span><span class="p">.</span><span class="nc">Loading</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">state</span><span class="p">:</span> <span class="nc">StateFlow</span><span class="p">&lt;</span><span class="nc">FavedState</span><span class="p">&gt;</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">_state</span>

    <span class="k">fun</span> <span class="nf">load</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">viewModelScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="n">fetchFavedQuotesUseCase</span><span class="p">.</span><span class="nf">invoke</span><span class="p">()</span>
                <span class="p">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="nc">FavedState</span><span class="p">.</span><span class="nc">Error</span> <span class="p">}</span>
                <span class="p">.</span><span class="nf">collect</span> <span class="p">{</span> <span class="n">favedQuotes</span> <span class="p">-&gt;</span>
                    <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="nc">FavedState</span><span class="p">.</span><span class="nc">Content</span><span class="p">(</span>
                        <span class="n">quotes</span> <span class="p">=</span> <span class="n">favedQuotes</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span>
                            <span class="n">it</span><span class="p">.</span><span class="nf">toFavedQuoteUi</span><span class="p">()</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">onDeleteStonkClicked</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nc">FavedQuoteUi</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">viewModelScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
            <span class="n">toggleFavouriteUseCase</span><span class="p">.</span><span class="nf">unsaved</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sealed</span> <span class="kd">class</span> <span class="nc">FavedState</span> <span class="p">{</span>
    <span class="kd">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="nc">FavedState</span><span class="p">()</span>
    <span class="kd">object</span> <span class="nc">Error</span> <span class="p">:</span> <span class="nc">FavedState</span><span class="p">()</span>
    <span class="kd">data class</span> <span class="nc">Content</span><span class="p">(</span><span class="kd">val</span> <span class="py">quotes</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">FavedQuoteUi</span><span class="p">&gt;)</span> <span class="p">:</span> <span class="nc">FavedState</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="next-steps">Next steps</h3>

<ul>
  <li>The iOS companion app implementation is missing. In general, its implementation wouldn‚Äôt differ much from Android, but there are some oddities depending on the Swift version used. More information about this can be found on <a href="https://github.com/rickclephas/KMP-NativeCoroutines">KMO-NativeCorouttines</a> or <a href="https://johnoreilly.dev/posts/swift_async_await_kotlin_coroutines/">Using Swift‚Äôs new async/await when invoking Kotlin Multiplatform code</a>.</li>
  <li>In <a href="https://github.com/Rafagf/stonks"><em>Stonks</em></a>, we have a mono-repo where the shared library and both Android and iOS live. This is fine for a pet project but not realistic in the real world. I‚Äôll create another article in which I‚Äôll explain how to decouple the library, so clients can consume it as another regular dependency, getting library updates with <a href="https://dependabot.com/">Dependabot</a> raising PRs.</li>
</ul>

<h3 id="summing-up">Summing up</h3>

<p>KMM is a fantastic tool reaching stable levels. Writing entire features twice, one for Android and one for iOS is expensive and bug-prone, and probably not acceptable for engineering teams in a not too far future. KMM provides a relatively straightforward solution to this problem while leaving the UI work to be built natively, which Native Mobile Developers are passionate about, especially with the arrival of declarative frameworks like <code class="language-plaintext highlighter-rouge">Jetpack Compose</code> or <code class="language-plaintext highlighter-rouge">SwiftUI</code>.</p>

<p>Hope you enjoyed the article. For any questions, my <a href="https://twitter.com/rafa_piki">twitter</a> account is the best place, but feel free to reach me anywhere you like!</p>

<h3 id="you-might-find-interesting"><em>You might find interesting‚Ä¶</em></h3>
<ul>
  <li><a href="/modelling-the-domain-layer-using-composables-use-cases/">Modelling the domain layer using composable use cases</a></li>
  <li><a href="/decompiling-kotlin-into-java/">Decompiling Kotlin into Java - Few years late</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#android" class="page__taxonomy-item" rel="tag">android</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ios" class="page__taxonomy-item" rel="tag">iOS</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#kotlin-multiplatform" class="page__taxonomy-item" rel="tag">kotlin multiplatform</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#kotlin" class="page__taxonomy-item" rel="tag">kotlin</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#mobile-development" class="page__taxonomy-item" rel="tag">mobile development</a>
    
    </span>
  </p>




        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-06-16T00:00:00+00:00">June 16, 2023</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Architecting+mobile+apps+with+Kotlin+Multiplatform%20%2Farchitecting-mobile-apps-with-kotlin-multiplatform%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2Farchitecting-mobile-apps-with-kotlin-multiplatform%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Farchitecting-mobile-apps-with-kotlin-multiplatform%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/automating-releases-with-a-release-pipeline/" class="pagination--pager" title="Automating releases with a Release Pipeline
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/automating-releases-with-a-release-pipeline/" rel="permalink">Automating releases with a Release Pipeline
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">At Memrise, we prioritize frequent updates to our apps, ideally on a weekly cadence. This approach offers numerous advantages over releasing only when signif...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/decompiling-kotlin-into-java/" rel="permalink">Decompiling Kotlin into Java - Few years late
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Recently I was asked by a co-worker ‚Äúwhat are sealed classes?‚Äù and realised the classic answer ‚Äúenums in steroid‚Äù falls really short and a clear sign that I ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/modelling-the-domain-layer-using-composables-use-cases/" rel="permalink">Modelling the domain layer using composable use cases
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Some time ago we had a problem inside the Memrise Android codebase with our domain layer. Repositories and Use Cases were heavily used but there weren‚Äôt clea...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/tracking-code-coverage-for-free/" rel="permalink">Tracking code coverage for free
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In the Android team at Memrise, we‚Äôve gotten a lot of value from tracking code coverage. It‚Äôs something we‚Äôve worked very hard to improve over the last few y...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Rafa Garcia. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>


    
  <script src="/assets/js/main.min.js"></script>





  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JQN7MDGSH4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JQN7MDGSH4', { 'anonymize_ip': false});
</script>







  </body>
</html>
