<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Tracking code coverage for free - Rafa Garcia</title>
<meta name="description" content="In the Android team at Memrise, we’ve gotten a lot of value from tracking code coverage. It’s something we’ve worked very hard to improve over the last few years. The main two reasons being:">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_UK">
<meta property="og:site_name" content="Rafa Garcia">
<meta property="og:title" content="Tracking code coverage for free">
<meta property="og:url" content="https://engineering.memrise.com/tracking-code-coverage-for-free-9d8ebd929293">


  <meta property="og:description" content="In the Android team at Memrise, we’ve gotten a lot of value from tracking code coverage. It’s something we’ve worked very hard to improve over the last few years. The main two reasons being:">







  <meta property="article:published_time" content="2021-04-24T00:00:00+00:00">






<link rel="canonical" href="https://engineering.memrise.com/tracking-code-coverage-for-free-9d8ebd929293">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Rafa Garcia",
      "url": "rafagarcia.dev/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Rafa Garcia Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    <style>
</style>
    <style>
</style>
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Rafa Garcia
          <span class="site-subtitle">Android Developer | Software Engineer</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blog/">Blog</a>
            </li><li class="masthead__menu-item">
              <a href="/cv/">CV</a>
            </li><li class="masthead__menu-item">
              <a href="/portfolio/">Portfolio</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content"
  padding-left: 80px>
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/rafa_avatar.jpeg" alt="" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Engineering in broken English</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">London / Granada</span>
        </li>
      

      
        
          
            <li><a href="mailto:rafagarfer@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/rafa_piki" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/rafagf/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/rafaelgarciafernandez/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">Linkedin</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Tracking code coverage for free">
    <meta itemprop="description" content="In the Android team at Memrise, we’ve gotten a lot of value from tracking code coverage. It’s something we’ve worked very hard to improve over the last few years. The main two reasons being:">
    <meta itemprop="datePublished" content="2021-04-24T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Tracking code coverage for free
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>In the Android team at Memrise, we’ve gotten a lot of value from tracking code coverage. It’s something we’ve worked very hard to improve over the last few years. The main two reasons being:</p>

<ol>
  <li><strong>Tests are great</strong>. They help us move faster and safer! Coverage is the indicator of how well we’re doing.</li>
  <li><strong>Coverage helps us find areas that need some love</strong> ❤️ Setting coverage goals as quarterly KPIs is a great motivator to improve our codebase.</li>
</ol>

<p>How do you track coverage? Well, as you’re probably aware, there are companies out there providing built-in solutions so you don’t have to do it yourself. We previously used one of the popular solutions but found that their pricing model wasn’t a good fit for our use case. After researching potential alternatives and not being convinced by any, we decided that building our own coverage tracking was the way to go!</p>

<h2 id="the-goal">The goal</h2>

<p>Implementation speed and maintenance were key aspects for us, as we prefer to spend our time making Memrise great! With this in mind, we wanted our solution to cover two requirements:</p>

<ol>
  <li><strong>Easy visualization of coverage stats</strong>. At Memrise we use Data Studio dashboards to track health metrics and KPIs, so we wanted to have a page to see stats like global coverage and coverage breakdown by module.</li>
  <li><strong>Coverage reports in Pull Requests.</strong> Coverage reports in PRs raise quality awareness and provide great immediate feedback to add those unit tests that you were lazy about.</li>
</ol>

<h3 id="generating-coverage">Generating coverage</h3>

<p>To generate the coverage of our codebase we use<a href="https://www.eclemma.org/jacoco/"> Jacoco</a>, an open-source code coverage library for Java and Kotlin. Jacoco gives you some goodies for free such as the ability to exclude code (i.e generated code or UI classes like Activities, Fragments, or Adapters) or choose the format of the generated report. It’s worth saying that Jacoco can be run at both global or module level. We do the latter since in the Memrise Android app we go big on modularisation.</p>

<p>To get an idea of how a CSV Jacoco report looks like, have a look at the screenshot.</p>

<p><img src="/assets/images/tracking-coverage-jacoco-example.png" alt="Example of a Jacoco report" /></p>

<p>Every row is a different class and every column an attribute. We’ll be using the <em>LINE_MISSED</em> and <em>LINE_COVERED</em> attributes.</p>

<p>To generate the report whenever we want it, we need to create a Gradle task (<em>:allCoverage)</em> that will do the following:</p>

<ol>
  <li>For each module, it runs Jacoco and generates <em>coverage.csv</em>. It then calculates total lines missed and total lines covered to come up with a coverage percentage for the module.</li>
  <li>Once it’s done with all the modules, it calculates the global coverage.</li>
  <li>Builds a JSON and stores it in <em>/build/coverage.json</em></li>
</ol>

<p>The generated JSON looks like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
   </span><span class="p">[</span><span class="s2">"global"</span><span class="p">,</span><span class="s2">"88.29%"</span><span class="p">],</span><span class="w">
   </span><span class="p">[</span><span class="s2">"billings"</span><span class="p">,</span><span class="s2">"80%"</span><span class="p">],</span><span class="w">
   </span><span class="p">[</span><span class="s2">"downloader"</span><span class="p">,</span><span class="s2">"23.76%"</span><span class="p">],</span><span class="w">
   </span><span class="p">[</span><span class="s2">"module-1"</span><span class="p">,</span><span class="s2">"99.47%"</span><span class="p">],</span><span class="w">
   </span><span class="p">[</span><span class="s2">"module-2"</span><span class="p">,</span><span class="s2">"0.47%"</span><span class="p">],</span><span class="w">
   </span><span class="p">[</span><span class="s2">"module-n"</span><span class="p">,</span><span class="s2">"0.47%"</span><span class="p">],</span><span class="w">
   </span><span class="err">...</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p><em>Disclaimer: all coverage values in this article are dummy!</em></p>

<h3 id="storing-reports-remotely">Storing reports remotely</h3>

<p>Now that we’re able to generate our coverage report, we need to put it somewhere. This could be a database or if you want to go for simplicity like us, a spreadsheet. The steps are relatively simple:</p>

<ol>
  <li>On every commit merged in <em>develop,</em> our CI will run the Gradle :<em>allCoverage</em> task.</li>
  <li>It will then look for our generated coverage.json inside the build directory and do a CURL (POST) to an <a href="https://developers.google.com/apps-script">AppScript</a> function linked to our new coverage spreadsheet.</li>
  <li>The script will parse the JSON and dump the data into our spreadsheet.</li>
</ol>

<p><img src="/assets/images/tracking-coverage-spreadsheet.png" alt="Coverage data stored in a spreadsheet" /></p>

<p>This is the result! 🎉 We store unique records per day and every new module will be added as a new column.</p>

<h3 id="visualizing-coverage">Visualizing coverage</h3>

<p>We needed to be able to easily visualize coverage reports. Since spreadsheets can be added as data sources in Data Studio, all we had to do is decide what type of data we want to see. Some examples could be plotting <em>global</em> coverage to make sure it keeps going up, or any specific feature module where the team wants to refactor or increase coverage.</p>

<p><img src="/assets/images/tracking-coverage-dashboard.png" alt="Example of coverage reports in our metrics dashboard" /></p>

<p>With this we’ve completed our first requirement: <strong>Easy visualization of coverage stats ✅</strong> Let’s now move onto coverage PR reports!</p>

<h3 id="coverage-reports-in-pull-requests">Coverage reports in Pull Requests</h3>

<p>Now that we’ve got a nice way to visualize our current coverage, it’s time to add reports to our Pull Requests to see if our changes are increasing or decreasing code coverage. To be more precise, we want to show the following: taking a branch with a PR open, we want to highlight coverage changes (both global and modules) versus <em>develop.</em></p>

<p>At Memrise, our Mobile Release Pipeline project automates different steps of our releases for both iOS and Android. The pipeline is composed of Firebase Functions that will execute different tasks, such as creating a release candidate in GitHub, posting a comment in a Jira ticket, or posting release notes in a Slack channel. In order to have coverage reports in Pull Requests, we use our release pipeline, but keep in mind it could be done with any system capable of making a call to GitHub’s API.</p>

<p>We’re going to create a new coverage Firebase Function in our Mobile Release Pipeline that can take the following parameters:</p>

<ul>
  <li>Pull request URL</li>
  <li>Branch name</li>
  <li>Coverage JSON</li>
</ul>

<p>Then, let’s split our commit workflows into 2 different scenarios:</p>

<ul>
  <li><strong>Committing to develop (AKA merging a PR)</strong>. Here we don’t want to show any report but to update our coverage spreadsheet. In other words, we want to have the same behavior as we had before but through the release pipeline. Instead of having our CI directly hitting our spreadsheet script, we’re going to hit our coverage Firebase Function. Then, our pipeline will do the POST to the spreadsheet script to update our coverage records.</li>
  <li><strong>Committing to any other branch with an open PR</strong>. Our CI will hit the coverage Firebase Function providing all the requested parameters. Then, the following steps will be performed in order:
    <ol>
      <li>Fetch <em>develop</em> coverage JSON by doing a GET to the spreadsheet script.</li>
      <li>Compare coverage reports and create a diff report using Markdown syntax.</li>
      <li>Find our PR in GitHub using GitHub’s API and post the report as a comment. It’s worth saying that if the coverage report already exists from a previous commit, we edit it instead of adding a new comment.</li>
    </ol>
  </li>
</ul>

<p>And with this, we’ll get beautiful reports in our Pull Requests, making our code coverage tracking work completed! <strong>✅ 🚀🚀🚀</strong></p>

<p><img src="/assets/images/tracking-coverage-github-comment.png" alt="Coverage report in GitHub" /></p>

<h3 id="next-steps">Next steps</h3>

<p>At this stage, we’ve got a fully functional solution to track coverage, so future improvements are optional and something to add when/if needed. Some ideas could be:</p>

<ul>
  <li>PR Checks (as in failing PRs if coverage goes down).</li>
  <li>Different base branches for coverage diff reports. Because we use a spreadsheet to store coverage records, we’re currently limited to <em>develop</em> for the diff reports. But it doesn’t need to be this way. A database would provide more flexibility.</li>
  <li>Using it on other platforms. The fact that it was built for Android doesn’t mean much since the tool itself is platform agnostic.</li>
</ul>

<h3 id="conclusions">Conclusions</h3>

<p>Tracking coverage has been valuable for our team and is something every team can do to improve the quality of the code they ship. There are good solutions out there, but if you’re looking for minimum cost and maximum flexibility, building an in-house tool to track coverage is much less complicated than you might think!</p>

<p>Hope you enjoyed the article. For any questions, my <a href="https://twitter.com/rafa_piki">twitter</a> account is the best place. Thanks for your time!</p>

<p>NOTE: <em>This article was first published in the <a href="https://engineering.memrise.com/tracking-code-coverage-for-free-9d8ebd929293">Memrise Engineering Blog</a>. Check the blog out, there’s great content!</em></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#android" class="page__taxonomy-item" rel="tag">android</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#mobile-development" class="page__taxonomy-item" rel="tag">mobile development</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#testing" class="page__taxonomy-item" rel="tag">testing</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#development" class="page__taxonomy-item" rel="tag">development</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-04-24T00:00:00+00:00">April 24, 2021</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Tracking+code+coverage+for+free%20rafagarcia.dev%2Ftracking-code-coverage-for-free%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=rafagarcia.dev%2Ftracking-code-coverage-for-free%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=rafagarcia.dev%2Ftracking-code-coverage-for-free%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/building-a-backend-an-api-and-a-web-client-using-ktor/" class="pagination--pager" title="Building a backend, an API and a web client using Ktor
">Previous</a>
    
    
      <a href="/modelling-the-domain-layer-using-composables-use-cases/" class="pagination--pager" title="Modelling the domain layer using composable use cases
">Next</a>
    
  </nav>

    </div>
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/automating-releases-with-a-release-pipeline/" rel="permalink">Automating releases with a Release Pipeline
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">At Memrise we like our apps to be updated as often as possible, ideally in a weekly cadence. We’ve noticed this gives us numerous advantages versus for examp...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/architecting-mobile-apps-with-kotlin-multiplatform/" rel="permalink">Architecting mobile apps with Kotlin Multiplatform
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Note: This article has been featured in both Android Weekly (#490) and Kotlin Weeekly (#273). Thanks to both! 🙏
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/decompiling-kotlin-into-java/" rel="permalink">Decompiling Kotlin into Java - Few years late
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Recently I was asked by a co-worker “what are sealed classes?” and realised the classic answer “enums in steroid” falls really short and a clear sign that I ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/modelling-the-domain-layer-using-composables-use-cases/" rel="permalink">Modelling the domain layer using composable use cases
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Some time ago we had a problem inside the Memrise Android codebase with our domain layer. Repositories and Use Cases were heavily used but there weren’t clea...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Rafa Garcia. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>


    
  <script src="/assets/js/main.min.js"></script>





  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JQN7MDGSH4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JQN7MDGSH4', { 'anonymize_ip': false});
</script>







  </body>
</html>
